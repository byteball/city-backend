import Store from '../store';
import { getAddressFromNearestRoad } from '../utils/getAddress';
import { IUnitOptions } from './../services/ogImageService';

function wrapSvgText(text: string, maxCharsPerLine = 23) {
    const words = text.split(' ');
    const lines = [];
    let currentLine = '';
  
    for (let word of words) {
      if ((currentLine + ' ' + word).length <= maxCharsPerLine) {
        currentLine += (currentLine ? ' ' : '') + word;
      } else {
        lines.push(currentLine);
        currentLine = word;
      }
    }
  
    if (currentLine) lines.push(currentLine);
  
    return lines.map((line, i) =>
      `<tspan x="60" dy="${i === 0 ? 0 : 60}">${line}</tspan>`
    ).join('');
  }

export const getUnitTemplate = async (options: IUnitOptions) => {
    const roads = await Store.getRoads();
    const type = options.house ? 'house' : 'plot';
    if (options[type] === undefined) throw new Error(`No ${type} number provided`);
    const unitData = await Store.getMapUnit(type, options[type]);

    if (!unitData) throw new Error(`No data found for ${type} ${options[type]}`);

    const address = getAddressFromNearestRoad(roads, unitData);

    const mapSize = 350;
    const mapOffset = 300;

    const transformedX = (unitData.x / 1e6) * mapSize - mapOffset;
    const transformedY = (unitData.y / 1e6) * mapSize - mapOffset;

    const svg = `
    <svg width="1200" height="630" viewBox="0 0 1200 630" fill="none" xmlns="http://www.w3.org/2000/svg">
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&amp;display=swap');

            text {
                font-family: 'Inter', sans-serif;
            }
        </style>
        <rect width="1200" height="630" fill="#131519"/>
        <rect width="1200" height="630" fill="url(#paint0_linear_1177_1223)"/>
        <path d="M257.145 115.75H247.19C247.009 114.462 246.637 113.318 246.077 112.318C245.516 111.303 244.796 110.439 243.918 109.727C243.039 109.015 242.024 108.47 240.872 108.091C239.736 107.712 238.501 107.523 237.168 107.523C234.759 107.523 232.66 108.121 230.872 109.318C229.084 110.5 227.698 112.227 226.713 114.5C225.728 116.758 225.236 119.5 225.236 122.727C225.236 126.045 225.728 128.833 226.713 131.091C227.713 133.348 229.107 135.053 230.895 136.205C232.683 137.356 234.751 137.932 237.099 137.932C238.418 137.932 239.637 137.758 240.759 137.409C241.895 137.061 242.902 136.553 243.781 135.886C244.66 135.205 245.387 134.379 245.963 133.409C246.554 132.439 246.963 131.333 247.19 130.091L257.145 130.136C256.887 132.273 256.243 134.333 255.213 136.318C254.198 138.288 252.827 140.053 251.099 141.614C249.387 143.159 247.342 144.386 244.963 145.295C242.599 146.189 239.925 146.636 236.94 146.636C232.789 146.636 229.077 145.697 225.804 143.818C222.546 141.939 219.971 139.22 218.077 135.659C216.198 132.098 215.259 127.788 215.259 122.727C215.259 117.652 216.213 113.333 218.122 109.773C220.031 106.212 222.622 103.5 225.895 101.636C229.168 99.7576 232.849 98.8182 236.94 98.8182C239.637 98.8182 242.137 99.197 244.44 99.9545C246.759 100.712 248.812 101.818 250.599 103.273C252.387 104.712 253.842 106.477 254.963 108.568C256.099 110.659 256.827 113.053 257.145 115.75ZM264.02 146V111.091H273.702V146H264.02ZM268.884 106.591C267.444 106.591 266.209 106.114 265.179 105.159C264.164 104.189 263.656 103.03 263.656 101.682C263.656 100.348 264.164 99.2045 265.179 98.25C266.209 97.2803 267.444 96.7955 268.884 96.7955C270.323 96.7955 271.55 97.2803 272.565 98.25C273.596 99.2045 274.111 100.348 274.111 101.682C274.111 103.03 273.596 104.189 272.565 105.159C271.55 106.114 270.323 106.591 268.884 106.591ZM300.026 111.091V118.364H279.003V111.091H300.026ZM283.776 102.727H293.457V135.273C293.457 136.167 293.594 136.864 293.866 137.364C294.139 137.848 294.518 138.189 295.003 138.386C295.503 138.583 296.079 138.682 296.73 138.682C297.185 138.682 297.639 138.644 298.094 138.568C298.548 138.477 298.897 138.409 299.139 138.364L300.662 145.568C300.177 145.72 299.495 145.894 298.616 146.091C297.738 146.303 296.67 146.432 295.412 146.477C293.079 146.568 291.033 146.258 289.276 145.545C287.533 144.833 286.177 143.727 285.207 142.227C284.238 140.727 283.76 138.833 283.776 136.545V102.727ZM312.31 159.091C311.082 159.091 309.931 158.992 308.855 158.795C307.795 158.614 306.916 158.379 306.219 158.091L308.401 150.864C309.537 151.212 310.56 151.402 311.469 151.432C312.393 151.462 313.188 151.25 313.855 150.795C314.537 150.341 315.09 149.568 315.514 148.477L316.082 147L303.56 111.091H313.741L320.969 136.727H321.332L328.628 111.091H338.878L325.31 149.773C324.658 151.652 323.772 153.288 322.651 154.682C321.545 156.091 320.143 157.174 318.446 157.932C316.749 158.705 314.704 159.091 312.31 159.091Z" fill="${type === "house" ? "black": "white"}"/>
        <rect x="60" y="89.6689" width="69.5121" height="11.9164" rx="5.95818" transform="rotate(-25.2658 60 89.6689)" fill="${type === "house" ? "black": "white"}"/>
        <rect width="69.5121" height="11.9164" rx="5.95818" transform="matrix(0.904337 0.426818 0.426818 -0.904337 113.576 70.8018)" fill="${type === "house" ? "black": "white"}" />
        <rect x="76.2119" y="89.7109" width="89.289" height="89.289" rx="44.6445" stroke="${type === "house" ? "black": "white"}" stroke-width="12"/>
        <rect x="638" y="100" width="455" height="455" rx="68" fill="#4C4C4C"/>
        <path transform="translate(${transformedX}, ${transformedY})"  d="M946.041 408.751C946.041 400.456 948.084 392.81 952.171 385.816C956.259 378.821 961.858 373.291 968.969 369.224C976.081 365.158 983.765 363.084 992.02 363.002C1000.28 362.921 1007.96 364.995 1015.07 369.224C1022.18 373.453 1027.78 378.984 1031.87 385.816C1035.96 392.648 1038 400.293 1038 408.751C1038 412.249 1037.14 416.315 1035.43 420.951C1033.71 425.587 1031.54 430.264 1028.93 434.981C1026.31 439.698 1023.33 444.497 1019.98 449.377C1016.62 454.257 1013.35 458.811 1010.17 463.04C1006.98 467.27 1004 471.011 1001.22 474.264C998.437 477.517 996.23 480.161 994.595 482.194L992.02 485C991.367 484.349 990.508 483.373 989.446 482.072C988.383 480.771 986.217 478.209 982.947 474.386C979.677 470.564 976.653 466.741 973.874 462.918C971.095 459.096 967.866 454.623 964.187 449.499C960.509 444.375 957.485 439.495 955.114 434.859C952.744 430.223 950.578 425.628 948.616 421.073C946.654 416.519 945.796 412.411 946.041 408.751ZM961.367 408.751C961.367 417.21 964.351 424.408 970.318 430.345C976.285 436.282 983.519 439.251 992.02 439.251C1000.52 439.251 1007.76 436.282 1013.72 430.345C1019.69 424.408 1022.67 417.21 1022.67 408.751C1022.67 400.293 1019.69 393.136 1013.72 387.28C1007.76 381.424 1000.52 378.415 992.02 378.252C983.519 378.089 976.285 381.099 970.318 387.28C964.351 393.461 961.367 400.618 961.367 408.751Z" fill="${type === "plot" ? "#084613" : "#C4A77D"}"/>
        <text
            x="60px" y="50%"
            fill="${type === "house" ? "black": "white"}"
            style="font-size:56px; max-width: 200px;"
        >
            ${wrapSvgText(address)}
        </text>

        <defs>
        <linearGradient id="paint0_linear_1177_1223" x1="0" y1="0" x2="1200" y2="0" gradientUnits="userSpaceOnUse">
        <stop stop-color="${type === "plot" ? '#084613' : '#C4A77D'}" stop-opacity="1"/>
        ${type === "plot" ? `<stop offset="0" stop-color="${type === "plot" ? '#084613' : '#C4A77D'}" stop-opacity="0.1"/>` : null}
        </linearGradient>
        </defs>
    </svg>
    `;

    return svg;
};