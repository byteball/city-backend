import config from "../config";
import store from "../store";

import { getAttestations } from "../utils/getAttestations";
import { getUserName } from "../utils/getUserName";

export const getUserTemplate = async (address: string) => {
    const state = await store.getActualState();
    if (!state) return 'No state';

    const houses = state[`user_houses_${address}`] ?? 0;
    const plots = Object.entries(state).filter(([name, value]) => name.startsWith('plot_') && (typeof value === "object" && "owner" in value) ? value.owner === address : false).length;

    const username = await getUserName(address) ?? "Unknown User";
    const attestations = await getAttestations(address);

    const discordUsername = attestations.find(att => att.attestor_address === config.DISCORD_ATTESTOR)?.profile.username as string | undefined ?? "No Discord";
    const tgUsername = attestations.find(att => att.attestor_address === config.TELEGRAM_ATTESTOR)?.profile.username as string | undefined ?? "No Telegram";

    const svg = `
        <svg width="1200" height="630" viewBox="0 0 1200 630" fill="none" xmlns="http://www.w3.org/2000/svg">
            <style>
                @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500,600,700&amp;display=swap');

                text {
                    font-family: 'Inter', sans-serif;
                }
            </style>
            
            <rect width="1200" height="630" rx="60" fill="#131519"/>
            <rect width="1200" height="630" rx="59" fill="url(#paint0_linear_1222_1309)"/>
            <path d="M257.145 115.75H247.19C247.009 114.462 246.637 113.318 246.077 112.318C245.516 111.303 244.796 110.439 243.918 109.727C243.039 109.015 242.024 108.47 240.872 108.091C239.736 107.712 238.501 107.523 237.168 107.523C234.759 107.523 232.66 108.121 230.872 109.318C229.084 110.5 227.698 112.227 226.713 114.5C225.728 116.758 225.236 119.5 225.236 122.727C225.236 126.045 225.728 128.833 226.713 131.091C227.713 133.348 229.107 135.053 230.895 136.205C232.683 137.356 234.751 137.932 237.099 137.932C238.418 137.932 239.637 137.758 240.759 137.409C241.895 137.061 242.902 136.553 243.781 135.886C244.66 135.205 245.387 134.379 245.963 133.409C246.554 132.439 246.963 131.333 247.19 130.091L257.145 130.136C256.887 132.273 256.243 134.333 255.213 136.318C254.198 138.288 252.827 140.053 251.099 141.614C249.387 143.159 247.342 144.386 244.963 145.295C242.599 146.189 239.925 146.636 236.94 146.636C232.789 146.636 229.077 145.697 225.804 143.818C222.546 141.939 219.971 139.22 218.077 135.659C216.198 132.098 215.259 127.788 215.259 122.727C215.259 117.652 216.213 113.333 218.122 109.773C220.031 106.212 222.622 103.5 225.895 101.636C229.168 99.7576 232.849 98.8182 236.94 98.8182C239.637 98.8182 242.137 99.197 244.44 99.9545C246.759 100.712 248.812 101.818 250.599 103.273C252.387 104.712 253.842 106.477 254.963 108.568C256.099 110.659 256.827 113.053 257.145 115.75ZM264.02 146V111.091H273.702V146H264.02ZM268.884 106.591C267.444 106.591 266.209 106.114 265.179 105.159C264.164 104.189 263.656 103.03 263.656 101.682C263.656 100.348 264.164 99.2045 265.179 98.25C266.209 97.2803 267.444 96.7955 268.884 96.7955C270.323 96.7955 271.55 97.2803 272.565 98.25C273.596 99.2045 274.111 100.348 274.111 101.682C274.111 103.03 273.596 104.189 272.565 105.159C271.55 106.114 270.323 106.591 268.884 106.591ZM300.026 111.091V118.364H279.003V111.091H300.026ZM283.776 102.727H293.457V135.273C293.457 136.167 293.594 136.864 293.866 137.364C294.139 137.848 294.518 138.189 295.003 138.386C295.503 138.583 296.079 138.682 296.73 138.682C297.185 138.682 297.639 138.644 298.094 138.568C298.548 138.477 298.897 138.409 299.139 138.364L300.662 145.568C300.177 145.72 299.495 145.894 298.616 146.091C297.738 146.303 296.67 146.432 295.412 146.477C293.079 146.568 291.033 146.258 289.276 145.545C287.533 144.833 286.177 143.727 285.207 142.227C284.238 140.727 283.76 138.833 283.776 136.545V102.727ZM312.31 159.091C311.082 159.091 309.931 158.992 308.855 158.795C307.795 158.614 306.916 158.379 306.219 158.091L308.401 150.864C309.537 151.212 310.56 151.402 311.469 151.432C312.393 151.462 313.188 151.25 313.855 150.795C314.537 150.341 315.09 149.568 315.514 148.477L316.082 147L303.56 111.091H313.741L320.969 136.727H321.332L328.628 111.091H338.878L325.31 149.773C324.658 151.652 323.772 153.288 322.651 154.682C321.545 156.091 320.143 157.174 318.446 157.932C316.749 158.705 314.704 159.091 312.31 159.091Z" fill="white"/>
            <rect x="60" y="89.6689" width="69.5121" height="11.9164" rx="5.95818" transform="rotate(-25.2658 60 89.6689)" fill="white"/>
            <rect width="69.5121" height="11.9164" rx="5.95818" transform="matrix(0.904337 0.426818 0.426818 -0.904337 113.576 70.8018)" fill="white"/>
            <rect x="76.2119" y="89.7109" width="89.289" height="89.289" rx="44.6445" stroke="white" stroke-width="12"/>
            
            ${/* username */ ''}
            <text x="64px" y="368px" fill="white" style="font-size:112px; max-width: 200px; font-weight: 600;">${username.length <= 16 ? username : username.slice(0, 16) + '...'}</text>

            ${/* plot count */ ''}
            <text x="938px" y="218px" fill="white" style="font-size:50px; max-width: 200px; font-weight: 500; letter-spacing: 3px;">${plots}</text>

            ${/* plot icon */ ''}
            <path d="M897.333 172H850.667C846.985 172 844 174.985 844 178.667V225.333C844 229.015 846.985 232 850.667 232H897.333C901.015 232 904 229.015 904 225.333V178.667C904 174.985 901.015 172 897.333 172Z" stroke="white" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
            
            ${/* home count */ ''}
            <text x="938px" y="112px" fill="white" style="font-size:50px; max-width: 200px; font-weight: 500;  letter-spacing: 3px;">${houses}</text>


            ${/* home icon */ ''}
            <path d="M888.546 130V100.774C888.546 99.8054 888.155 98.8762 887.458 98.1911C886.762 97.506 885.818 97.1211 884.834 97.1211H869.985C869.001 97.1211 868.056 97.506 867.36 98.1911C866.664 98.8762 866.273 99.8054 866.273 100.774V130" stroke="white" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M844 89.4726C844 88.4007 844.235 87.3417 844.69 86.3693C845.144 85.397 845.807 84.5348 846.632 83.8429L872.617 61.7408C873.957 60.6167 875.655 60 877.409 60C879.164 60 880.861 60.6167 882.201 61.7408L908.186 83.8429C909.011 84.5348 909.674 85.397 910.129 86.3693C910.583 87.3417 910.818 88.4007 910.818 89.4726V122.631C910.818 124.586 910.036 126.46 908.644 127.842C907.251 129.224 905.363 130 903.394 130H851.424C849.455 130 847.567 129.224 846.175 127.842C844.782 126.46 844 124.586 844 122.631V89.4726Z" stroke="white" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
            
            ${/* discord icon */ ''}
            <path d="M120.299 506.767C114.242 501.868 104.659 501.037 104.249 501.008C103.613 500.954 103.007 501.312 102.745 501.904C102.722 501.939 102.514 502.423 102.282 503.176C106.288 503.857 111.21 505.225 115.662 508.003C116.376 508.445 116.596 509.389 116.156 510.106C115.864 510.578 115.371 510.835 114.86 510.835C114.586 510.835 114.307 510.757 114.057 510.602C106.401 505.829 96.8427 505.59 95 505.59C93.1573 505.59 83.5929 505.829 75.9426 510.602C75.2293 511.05 74.2901 510.829 73.8502 510.112C73.4044 509.389 73.6243 508.451 74.3376 508.003C78.7899 505.231 83.7118 503.857 87.7182 503.182C87.4864 502.423 87.2784 501.945 87.2605 501.904C86.993 501.312 86.3927 500.942 85.7507 501.008C85.3405 501.037 75.7583 501.868 69.6179 506.832C66.4139 509.813 60 527.234 60 542.294C60 542.563 60.0713 542.82 60.2021 543.053C64.6247 550.867 76.6975 552.91 79.4497 553C79.4616 553 79.4794 553 79.4973 553C79.9847 553 80.4424 552.767 80.7278 552.373L83.5097 548.525C76.002 546.578 72.168 543.268 71.948 543.071C71.3179 542.515 71.2585 541.548 71.8173 540.914C72.3701 540.281 73.3331 540.221 73.9631 540.777C74.0523 540.861 81.1141 546.883 95 546.883C108.91 546.883 115.971 540.837 116.043 540.777C116.673 540.227 117.63 540.281 118.189 540.92C118.742 541.554 118.682 542.515 118.052 543.071C117.832 543.268 113.998 546.578 106.49 548.525L109.272 552.373C109.558 552.767 110.015 553 110.503 553C110.521 553 110.538 553 110.55 553C113.302 552.91 125.375 550.867 129.798 543.053C129.929 542.82 130 542.563 130 542.294C130 527.234 123.586 509.813 120.299 506.767ZM85.1087 536.177C82.1663 536.177 79.7826 533.441 79.7826 530.06C79.7826 526.678 82.1663 523.942 85.1087 523.942C88.0511 523.942 90.4348 526.678 90.4348 530.06C90.4348 533.441 88.0511 536.177 85.1087 536.177ZM104.891 536.177C101.949 536.177 99.5652 533.441 99.5652 530.06C99.5652 526.678 101.949 523.942 104.891 523.942C107.834 523.942 110.217 526.678 110.217 530.06C110.217 533.441 107.834 536.177 104.891 536.177Z" fill="white"/>
            
            ${/* discord username */ ''}
            <text x="160px" y="544px" fill="white" style="font-size:50px; max-width: 200px; font-weight: 500; letter-spacing: 1px;">${discordUsername}</text>

                        
            <g transform="translate(120, 0)">
                ${/* telegram username */ ''}
                <text x="600px" y="544px" fill="white" style="font-size:50px; max-width: 200px; font-weight: 500; letter-spacing: 1px;">${tgUsername}</text>

                ${/* telegram icon */ ''}
                <path d="M534 492C527.078 492 520.311 494.053 514.555 497.899C508.799 501.744 504.313 507.211 501.664 513.606C499.015 520.001 498.322 527.039 499.673 533.828C501.023 540.618 504.356 546.854 509.251 551.749C514.146 556.644 520.383 559.977 527.172 561.327C533.961 562.678 540.999 561.985 547.394 559.336C553.789 556.687 559.256 552.201 563.102 546.445C566.947 540.689 569 533.923 569 527C569 517.717 565.312 508.815 558.749 502.251C552.185 495.687 543.282 492 534 492ZM551.194 515.975L545.463 543.056C545.025 544.981 543.888 545.419 542.269 544.544L533.519 538.069L529.144 542.137C528.938 542.407 528.673 542.625 528.37 542.777C528.067 542.928 527.733 543.009 527.394 543.012L528.006 534.262L544.194 519.606C544.938 518.994 544.194 518.644 543.144 519.256L523.281 531.725L514.531 529.012C512.65 528.444 512.606 527.131 514.925 526.256L548.656 513.131C550.319 512.65 551.719 513.612 551.194 515.975Z" fill="white"/>
            </g>
            <defs>
            <linearGradient id="paint0_linear_1222_1309" x1="0" y1="0" x2="1200" y2="0" gradientUnits="userSpaceOnUse">
                <stop stop-color="#AAFDB5" stop-opacity="0.3"/>
                <stop offset="1" stop-color="#9089FC" stop-opacity="0"/>
            </linearGradient>
            </defs>
        </svg>
`;

    return svg;
};